name: Update GitHub stats and deploy

on:
  schedule:
    - cron: "55 * * * *"   # every hour at :55 UTC
  workflow_dispatch:
  push:
    branches: [ master ]   # your repo is on master

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate _data/github.json
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_USER: alessioborgi
        run: |
          mkdir -p _data
          python - << 'PY'
          import os, sys, json, urllib.request, urllib.parse

          token = os.environ.get("GH_TOKEN", "")
          user  = os.environ.get("GITHUB_USER", "")
          if not user:
              print("GITHUB_USER is missing", file=sys.stderr)
              sys.exit(1)

          headers = {"Accept": "application/vnd.github+json"}
          if token:
              headers["Authorization"] = f"Bearer {token}"

          def gh(url, params=None):
              if params:
                  url = url + "?" + urllib.parse.urlencode(params)
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req) as resp:
                  return json.loads(resp.read().decode("utf-8"))

          # 1) user info
          user_data = gh(f"https://api.github.com/users/{user}")

          # 2) all repos (owner only), paginated
          repos = []
          page = 1
          while True:
              data = gh(
                  f"https://api.github.com/users/{user}/repos",
                  {"per_page": 100, "page": page, "type": "owner", "sort": "updated"}
              )
              if not data:
                  break
              repos.extend(data)
              page += 1
              if page > 10:   # safety
                  break

          total_stars = sum(r.get("stargazers_count", 0) for r in repos)
          total_forks = sum(r.get("forks_count", 0) for r in repos)

          # language breakdown (exclude forks)
          lang_totals = {}
          for r in repos:
              if r.get("fork", False):
                  continue
              langs = gh(r["languages_url"]) or {}
              for name, count in langs.items():
                  lang_totals[name] = lang_totals.get(name, 0) + count

          top_langs = sorted(lang_totals.items(), key=lambda kv: kv[1], reverse=True)[:8]
          total_lang_bytes = sum(lang_totals.values()) or 1
          top_languages = [
              {
                  "name": name,
                  "bytes": count,
                  "percent": round(count * 100.0 / total_lang_bytes, 1),
              }
              for name, count in top_langs
          ]

          top = sorted(
              [r for r in repos if not r.get("fork", False)],
              key=lambda r: r.get("stargazers_count", 0),
              reverse=True
          )[:12]

          popular = [{
              "name": r["name"],
              "html_url": r["html_url"],
              "description": r.get("description") or "",
              "stars": r.get("stargazers_count", 0),
              "forks": r.get("forks_count", 0),
              "language": r.get("language") or "—",
          } for r in top]

          out = {
              "username": user,
              "total_stars": total_stars,
              "total_forks": total_forks,
              "public_repos": user_data.get("public_repos", len(repos)),
              "followers": user_data.get("followers", 0),
              "top_languages": top_languages,
              "popular_repos": popular,
          }

          with open("_data/github.json", "w") as f:
              json.dump(out, f, indent=2)

          print("✅ wrote _data/github.json")
          PY

      - name: Commit stats (if changed)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add _data/github.json
          git diff --quiet && echo "No changes" || git commit -m "Update GitHub stats"
          git push

      # ---- build & deploy Pages ----
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
